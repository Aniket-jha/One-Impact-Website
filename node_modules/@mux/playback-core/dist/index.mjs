import h from"mux-embed";import m from"hls.js";var M=class extends Error{constructor(r,n=M.MEDIA_ERR_CUSTOM,o){var a;super(r);this.name="MediaError",this.code=n,this.fatal=o!=null?o:n>=M.MEDIA_ERR_NETWORK&&n<=M.MEDIA_ERR_ENCRYPTED,this.message||(this.message=(a=M.defaultMessages[this.code])!=null?a:"")}},l=M;l.MEDIA_ERR_ABORTED=1,l.MEDIA_ERR_NETWORK=2,l.MEDIA_ERR_DECODE=3,l.MEDIA_ERR_SRC_NOT_SUPPORTED=4,l.MEDIA_ERR_ENCRYPTED=5,l.MEDIA_ERR_CUSTOM=100,l.defaultMessages={1:"You aborted the media playback",2:"A network error caused the media download to fail.",3:"A media error caused playback to be aborted. The media could be corrupt or your browser does not support this format.",4:"An unsupported error occurred. The server or network failed, or your browser does not support this format.",5:"The media is encrypted and there are no keys to decrypt it."};import w from"hls.js";var P=(e,t)=>e in t,v={ANY:"any",MUTED:"muted"},g={VOD:"on-demand",ON_DEMAND:"on-demand",LIVE:"live",LL_LIVE:"ll-live",DVR:"live:dvr",LL_DVR:"ll-live:dvr"},k={MSE:"mse",NATIVE:"native"},y={M3U8:"application/vnd.apple.mpegurl",MP4:"video/mp4"},L={HLS:y.M3U8},le=Object.keys(L),pe=[...Object.values(y),"hls","HLS"];var T=(e,t,r,n)=>{e.addEventListener(t,r,n),e.addEventListener("teardown",()=>{e.removeEventListener(t,r)},{once:!0})};function S(e,t,r){t&&r>t&&(r=t);for(let n=0;n<e.length;n++)if(e.start(n)<=r&&e.end(n)>=r)return!0;return!1}var H=e=>{let t=e.indexOf("?");if(t<0)return[e];let r=e.slice(0,t),n=e.slice(t);return[r,n]},_=e=>{let t=e.type;if(t){let n=t.toUpperCase();return P(n,L)?L[n]:t}let{src:r}=e;return r?J(r):""},J=e=>{let t="";try{t=new URL(e).pathname}catch{console.error("invalid url")}let r=t.lastIndexOf(".");if(r<0)return"";let o=t.slice(r+1).toUpperCase();return P(o,y)?y[o]:""};var Q=Object.values(v),C=e=>typeof e=="boolean"||typeof e=="string"&&Q.includes(e),O=({autoplay:e},t,r)=>{if(!t)return()=>{};let n=!1,o=!1,a=C(e)?e:!!e,s=()=>{n||T(t,"playing",()=>{n=!0},{once:!0})};if(s(),T(t,"loadstart",()=>{n=!1,s(),A(t,a)},{once:!0}),T(t,"loadstart",()=>{r||(o=!Number.isFinite(t.duration)),A(t,a)},{once:!0}),r&&r.once(w.Events.LEVEL_LOADED,(c,d)=>{var u;o=(u=d.details.live)!=null?u:!1}),!a){let c=()=>{!o||(r!=null&&r.liveSyncPosition?t.currentTime=r.liveSyncPosition:Number.isFinite(t.seekable.end(0))&&(t.currentTime=t.seekable.end(0)))};r&&T(t,"play",()=>{t.preload==="metadata"?r.once(w.Events.LEVEL_UPDATED,c):c()},{once:!0})}return c=>{n||(a=C(c)?c:!!c,A(t,a))}},A=(e,t)=>{if(!t)return;let r=e.muted,n=()=>e.muted=r;switch(t){case v.ANY:e.play().catch(()=>{e.muted=!0,e.play().catch(n)});break;case v.MUTED:e.muted=!0,e.play().catch(n);break;default:e.play().catch(()=>{});break}};var V=({preload:e,src:t},r,n)=>{if(!r)return()=>{};let o=p=>{p!=null&&["","none","metadata","auto"].includes(p)?r.setAttribute("preload",p):r.removeAttribute("preload")};if(!n)return o(e),o;let a=!1,s=!1,i=n.config.maxBufferLength,c=n.config.maxBufferSize,d=p=>{o(p);let f=p!=null?p:r.preload;s||f==="none"||(f==="metadata"?(n.config.maxBufferLength=1,n.config.maxBufferSize=1):(n.config.maxBufferLength=i,n.config.maxBufferSize=c),u())},u=()=>{!a&&t&&(a=!0,n.loadSource(t))};return T(r,"play",()=>{s=!0,n.config.maxBufferLength=i,n.config.maxBufferSize=c,u()},{once:!0}),d(e),d};import E from"hls.js";function N(e,t){t.on(E.Events.NON_NATIVE_TEXT_TRACKS_FOUND,(o,{tracks:a})=>{a.forEach(s=>{var d;let i=(d=s.subtitleTrack)!=null?d:s.closedCaptions,c=t.subtitleTracks.findIndex(({lang:u,name:p,type:f})=>u==(i==null?void 0:i.lang)&&p===s.label&&f.toLowerCase()===s.kind);U(e,s.kind,s.label,i==null?void 0:i.lang,`${s.kind}${c}`)})});let r=()=>{var s;if(!t.subtitleTracks.length)return;let o=Array.from(e.textTracks).find(i=>i.id&&i.mode==="showing"&&["subtitles","captions"].includes(i.kind)),a=`${(s=t.subtitleTracks[t.subtitleTrack])==null?void 0:s.type.toLowerCase()}${t.subtitleTrack}`;if(o&&(t.subtitleTrack<0||(o==null?void 0:o.id)!==a)){let i=t.subtitleTracks.findIndex(({lang:c,name:d,type:u})=>c==o.language&&d===o.label&&u.toLowerCase()===o.kind);t.subtitleTrack=i}o&&(o==null?void 0:o.id)===a&&o.cues&&Array.from(o.cues).forEach(i=>{o.addCue(i)})};e.textTracks.addEventListener("change",r),t.on(E.Events.CUES_PARSED,(o,{track:a,cues:s})=>{let i=e.textTracks.getTrackById(a);if(!i)return;let c=i.mode==="disabled";c&&(i.mode="hidden"),s.forEach(d=>{var u;(u=i.cues)!=null&&u.getCueById(d.id)||i.addCue(d)}),c&&(i.mode="disabled")}),t.once(E.Events.DESTROYING,()=>{e.textTracks.removeEventListener("change",r),e.querySelectorAll("track[data-removeondestroy]").forEach(a=>{a.remove()})});let n=()=>{Array.from(e.textTracks).forEach(o=>{var a,s;if(!["subtitles","caption"].includes(o.kind)&&o.label==="thumbnails"){if(!((a=o.cues)!=null&&a.length)){let i=e.querySelector('track[label="thumbnails"]'),c=(s=i==null?void 0:i.getAttribute("src"))!=null?s:"";i==null||i.removeAttribute("src"),setTimeout(()=>{i==null||i.setAttribute("src",c)},0)}o.mode!=="hidden"&&(o.mode="hidden")}})};t.once(E.Events.MANIFEST_LOADED,n),t.once(E.Events.MEDIA_ATTACHED,n)}function U(e,t,r,n,o){let a=document.createElement("track");return a.kind=t,a.label=r,n&&(a.srclang=n),o&&(a.id=o),a.track.mode="disabled",a.setAttribute("data-removeondestroy",""),e.append(a),a.track}function Z(e,t){let r=Array.prototype.find.call(e.querySelectorAll("track"),n=>n.track===t);r==null||r.remove()}var K,B,j=(B=(K=globalThis==null?void 0:globalThis.navigator)==null?void 0:K.userAgent)!=null?B:"",ee=j.toLowerCase().indexOf("android")!==-1,x=new WeakMap,q="mux.com",F,W,z=(W=(F=m).isSupported)==null?void 0:W.call(F),te=ee,Oe=()=>h.utils.now(),R=h.utils.generateUUID,Ve=(e,{domain:t=q}={})=>{if(!e)return;let[r,n=""]=H(e);return`https://stream.${t}/${r}.m3u8${n}`},re=e=>{if(!e)return;let[t]=e.split("?");return t||void 0},ne=e=>{if(!e||!e.startsWith("https://stream."))return;let[t]=new URL(e).pathname.slice(1).split(".m3u8");return t||void 0},oe=e=>{var t,r,n;return(t=e==null?void 0:e.metadata)!=null&&t.video_id?e.metadata.video_id:$(e)&&(n=(r=re(e.playbackId))!=null?r:ne(e.src))!=null?n:R()},Ne=e=>{var t;return(t=x.get(e))==null?void 0:t.error},Ue=(e,t,r)=>{ae(t,r);let{metadata:n={}}=e,{view_session_id:o=R()}=n,a=oe(e);n.view_session_id=o,n.video_id=a,e.metadata=n,x.set(t,{});let s=ie(e,t);ce(e,t,s),de(e,t,s);let i=O(e,t,s),c=V(e,t,s);return{engine:s,setAutoplay:i,setPreload:c}},ae=(e,t)=>{let r=t==null?void 0:t.engine;r&&(r.detachMedia(),r.destroy()),(e==null?void 0:e.mux)&&!e.mux.deleted&&(e.mux.destroy(),delete e.mux),e&&(e.removeAttribute("src"),e.load(),e.removeEventListener("error",G),e.removeEventListener("error",I),e.removeEventListener("durationchange",X),x.delete(e),e.dispatchEvent(new Event("teardown")))};function Y(e,t){var d;let r=_(e);if(!(r===y.M3U8))return!0;let o=!r||((d=t==null?void 0:t.canPlayType(r))!=null?d:!0),{preferPlayback:a}=e,s=a===k.MSE,i=a===k.NATIVE;return o&&(i||!(z&&(s||te)))}var ie=(e,t)=>{let{debug:r,streamType:n,startTime:o=-1,metadata:a,experimentalCmcd:s}=e,c=_(e)===y.M3U8,d=Y(e,t);if(c&&!d&&z){let u={backBufferLength:30,renderTextTracksNatively:!1,liveDurationInfinity:!0},p=se(n),f=s?{useHeaders:!0,sessionId:a.view_session_id,contentId:a.video_id}:void 0;return new m({debug:r,startPosition:o,cmcd:f,...u,...p})}},se=e=>[g.LIVE,g.DVR].includes(e)?{backBufferLength:8}:[g.LL_LIVE,g.LL_DVR].includes(e)?{backBufferLength:4,maxFragLookUpTolerance:.001}:{},$=({playbackId:e,src:t,customDomain:r})=>{if(e)return!0;if(typeof t!="string")return!1;let n=window==null?void 0:window.location.href,o=new URL(t,n).hostname.toLocaleLowerCase();return o.includes(q)||!!r&&o.includes(r.toLocaleLowerCase())},ce=(e,t,r)=>{var a;let{envKey:n}=e,o=$(e);if((n||o)&&t){let{playerInitTime:s,playerSoftwareName:i,playerSoftwareVersion:c,beaconCollectionDomain:d,debug:u,disableCookies:p}=e,f={...e.metadata,video_title:((a=e==null?void 0:e.metadata)==null?void 0:a.video_title)||void 0},D=b=>typeof b.player_error_code=="string"?!1:typeof e.errorTranslator=="function"?e.errorTranslator(b):b;h.monitor(t,{debug:u,beaconCollectionDomain:d,hlsjs:r,Hls:r?m:void 0,automaticErrorTracking:!1,errorTranslator:D,disableCookies:p,data:{...n?{env_key:n}:{},player_software_name:i,player_software:i,player_software_version:c,player_init_time:s,...f}})}},de=(e,t,r)=>{var a;if(!t){console.warn("attempting to load media before mediaEl exists");return}let n=Y(e,t),{src:o}=e;t&&n?(typeof o=="string"?(t.setAttribute("src",o),e.startTime&&(((a=x.get(t))!=null?a:{}).startTime=e.startTime,t.addEventListener("durationchange",X,{once:!0}))):t.removeAttribute("src"),t.addEventListener("error",G),t.addEventListener("error",I)):r&&o?(r.on(m.Events.ERROR,(s,i)=>{let c={[m.ErrorTypes.NETWORK_ERROR]:l.MEDIA_ERR_NETWORK,[m.ErrorTypes.MEDIA_ERROR]:l.MEDIA_ERR_DECODE},d=new l("",c[i.type]);d.fatal=i.fatal,d.data=i,t.dispatchEvent(new CustomEvent("error",{detail:d}))}),t.addEventListener("error",I),N(t,r),r.attachMedia(t)):console.error("It looks like the video you're trying to play will not work on this system! If possible, try upgrading to the newest versions of your browser or software.")};function X(e){var n;let t=e.target,r=(n=x.get(t))==null?void 0:n.startTime;if(!!r&&S(t.seekable,t.duration,r)){let o=t.preload==="auto";o&&(t.preload="none"),t.currentTime=r,o&&(t.preload="auto")}}async function G(e){if(!e.isTrusted)return;e.stopImmediatePropagation();let t=e.target;if(!(t!=null&&t.error))return;let{message:r,code:n}=t.error,o=new l(r,n);if(t.src&&(n!==l.MEDIA_ERR_DECODE||n!==void 0))try{let{status:a}=await fetch(t.src);o.data={response:{code:a}}}catch{}t.dispatchEvent(new CustomEvent("error",{detail:o}))}function I(e){var n,o;if(!(e instanceof CustomEvent)||!(e.detail instanceof l))return;let t=e.target,r=e.detail;!r||!r.fatal||(((n=x.get(t))!=null?n:{}).error=r,(o=t.mux)==null||o.emit("error",{player_error_code:r.code,player_error_message:r.message}))}export{v as AutoplayTypes,y as ExtensionMimeTypeMap,m as Hls,l as MediaError,L as MimeTypeShorthandMap,k as PlaybackTypes,g as StreamTypes,U as addTextTrack,pe as allMediaTypes,Oe as generatePlayerInitTime,R as generateUUID,Ne as getError,se as getStreamTypeConfig,Ue as initialize,P as isKeyOf,$ as isMuxVideoSrc,de as loadMedia,h as mux,Z as removeTextTrack,ie as setupHls,ce as setupMux,le as shorthandKeys,ae as teardown,Ve as toMuxVideoURL};
//# sourceMappingURL=index.mjs.map
